#if GL_OES_standard_derivatives
#extension GL_OES_standard_derivatives:enable
#endif
#ifndef saturate
#define saturate(a)clamp( a,0.0,1.0)
#endif
varying vec2 vUv;varying vec3 vNormal,vWorldNormal,vWorldPosition,vViewPosition,vEyedir;uniform sampler2D painttexture,basetexture,exptexture,weartexture,normaltexture,grungetexture,maskstexture,aotexture,alphatexture;uniform float lightboost,wear;uniform int paintstyle,use_normal;uniform float phongboost,phongintensity,phongexponent,phongalbedoboost;
#define MAX_LIGHTS 4
struct LightInfo{vec4 color;vec4 position;};uniform LightInfo lights[MAX_LIGHTS];uniform int NumLights;float v(vec3 v,vec3 c){float n=1.-saturate(dot(v,c));return n*n;}float v(vec3 e,vec3 c,vec3 n){float z,t=v(e,c);if(t>.5)z=mix(n.y,n.z,2.*t-1.);else z=mix(n.x,n.y,2.*t);return z;}float v(float v){return(v+v*v)*.5;}vec3 f(vec3 v){return pow(v,vec3(2.2));}vec3 f(bool z,vec3 e,vec3 c){float n,t=dot(e,c);if(z)n=saturate(t*.5+.5),n*=n;else n=saturate(t),n=v(n);vec3 i=vec3(n);return i;}float f(const vec3 v,const vec3 n){float c=length(v-n);return 1./(1.+8e-4*c+.00032*(c*c));}vec3 f(const float v,const vec3 c,const vec3 n,const vec3 e,const vec3 z,const bool t){vec3 i=normalize(e-c);return z*f(e,c)*f(t,n,i);}vec3 e(const vec3 v,const vec3 n[6]){vec3 e,c=v*v,r=vec3(v.x<0.,v.y<0.,v.z<0.),i=1.-r;r*=c;i*=c;e=i.x*n[0]+r.x*n[1]+i.y*n[2]+r.y*n[3]+i.z*n[4]+r.z*n[5];return e;}vec3 n(const vec3 v,const vec3 c[6]){return e(v,c);}vec3 e(const vec3 v,const vec3 c,const vec3 e,const bool z,const bool t,const vec4 i,const vec3 p[6],const int b,LightInfo d[MAX_LIGHTS],const bool y){vec3 r=vec3(0.);if(z&&!t)r+=f(e*2.);if(t)r+=n(c,p);if(b>0)r+=f(i.x,v,c,d[0].position.xyz,d[0].color.xyz,true);if(b>1)r+=f(i.y,v,c,d[1].position.xyz,d[1].color.xyz,true);if(b>2)r+=f(i.z,v,c,d[2].position.xyz,d[2].color.xyz,true);if(b>3){vec3 l=vec3(d[0].color.w,d[0].position.w,d[1].color.w),w=vec3(d[1].position.w,d[2].color.w,d[2].position.w);r+=f(i.w,v,c,w,l,true);}return r;}vec3 f(const vec3 v,const vec3 c,const vec3 n,const bool z,const bool i,const vec4 t,const vec3 d[6],const int l,LightInfo p[MAX_LIGHTS],const bool f){vec3 r=e(v,c,n,z,i,t,d,l,p,f);return r;}vec3 e(const vec3 v,const vec3 c,const float n,const vec3 e,const vec3 z){vec3 i=normalize(e.xyz+c.xyz);float t=saturate(dot(v.xyz,i.xyz));vec3 r=vec3(pow(t,n));r*=pow(saturate(dot(v,c)),.5);r*=z;return r;}vec3 e(const vec3 v,LightInfo c[MAX_LIGHTS],int n){if(n==0)return normalize(c[0].position.xyz-v);else if(n==1)return normalize(c[1].position.xyz-v);else if(n==2)return normalize(c[2].position.xyz-v);else if(n==3){vec3 e=vec3(c[1].position.w,c[2].color.w,c[2].position.w);return normalize(e-v);}}vec3 c(LightInfo v[MAX_LIGHTS],int n){if(n==0)return v[0].color.xyz;else if(n==1)return v[1].color.xyz;else if(n==2)return v[2].color.xyz;else if(n==3);}vec3 c(const vec3 v,const vec3 n,const float c,const vec3 z,const float i,const vec3 t,const vec3 d){return e(n,d,c,z,t*f(d,v));}vec3 e(const vec3 v,const vec3 n,const float z,const vec3 i,const vec4 t,const int b,LightInfo d[MAX_LIGHTS]){vec3 r,p;r=c(v,n,z,i,t.x,d[0].color.xyz,normalize(cameraPosition-v));p+=r*f(d[0].position.xyz,v);if(b>0)r=c(v,n,z,i,t.x,c(d,0),e(v,d,0)),p+=r*f(d[0].position.xyz,v);if(b>1)r=c(v,n,z,i,t.y,c(d,1),e(v,d,1)),p+=r*f(d[1].position.xyz,v);if(b>2)r=c(v,n,z,i,t.z,c(d,2),e(v,d,2)),p+=r*f(d[2].position.xyz,v);return p;}vec3 c(vec3 v,vec3 n,vec3 c){vec3 i=vec3(dFdx(n.x),dFdx(n.y),dFdx(n.z)),r=vec3(dFdy(n.x),dFdy(n.y),dFdy(n.z));vec2 t=dFdx(vUv.xy),d=dFdy(vUv.xy);float e=sign(d.y*t.x-t.y*d.x);vec3 z=normalize((i*d.y-r*t.y)*e),l=normalize((-i*d.x+r*t.x)*e),p=normalize(c);mat3 b=mat3(z,l,p);vec3 f=v*2.-1.;f.xy*=1.;f.xy*=float(gl_FrontFacing)*2.-1.;return normalize(b*f);}void main(){vec4 n=texture2D(basetexture,vUv),t=texture2D(exptexture,vUv),r=texture2D(alphatexture,vUv),d=n;vec3 z=vWorldPosition,i=normalize(vWorldNormal);float p=v(i,vEyedir,vec3(.85,.85,1.));if(use_normal==1){vec4 b=texture2D(normaltexture,vUv);i=c(b.xyz,z,i);}vec3 l[6];l[0]=vec3(1.);l[1]=vec3(1.);l[2]=vec3(1.);l[3]=vec3(1.);l[4]=vec3(1.);l[5]=vec3(1.);vec4 b=vec4(1.);vec3 s=f(z,i,vec3(0.),false,true,b,l,3,lights,false);bool y=paintstyle==0||paintstyle==4||paintstyle==5||paintstyle==6||paintstyle==8||paintstyle==9;float w=((t.x>0.)?t.x:0.0000001)*255.;if(phongexponent>0.&&!y)w=phongexponent;vec3 x=e(z,i,w,vEyedir,b,3,lights);if(phongalbedoboost>0.&&y)x*=mix(vec3(1.),phongalbedoboost*d.xyz,t.y);else x*=vec3(1.)*(1./255.*phongintensity);if(use_normal!=1)x*=r.z;x*=p;d.xyz*=s;d.xyz+=x;gl_FragColor=vec4(d.xyz*lightboost,1.);}